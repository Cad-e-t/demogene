
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- Create Table: videos
create table public.videos (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Link to Auth User
  user_id uuid references auth.users not null,

  -- The original filename or project name
  title text,
  
  -- URLs to the files in the 'uploads' bucket
  input_video_url text not null,
  final_video_url text,
  
  -- Processing status
  status text default 'processing' check (status in ('processing', 'completed', 'failed')),
  
  -- Store metadata used for generation
  voice_id text,
  crop_data jsonb, -- {x, y, width, height}
  trim_data jsonb, -- {start, end}
  
  -- Store the Gemini Analysis result
  analysis_result jsonb
);

-- Enable RLS
alter table public.videos enable row level security;

-- Policies
-- 1. Users can only see their own videos
create policy "Users can view own videos" on public.videos
    for select using (auth.uid() = user_id);

-- 2. Users can insert their own videos
create policy "Users can insert own videos" on public.videos
    for insert with check (auth.uid() = user_id);

-- 3. Users can update their own videos
create policy "Users can update own videos" on public.videos
    for update using (auth.uid() = user_id);

-- Storage Bucket Setup
-- 1. Go to Storage in Supabase Dashboard
-- 2. Create a new public bucket named "uploads"

-- Storage Policies (SQL representation)
-- Allow authenticated users to upload and read
begin;
  insert into storage.buckets (id, name, public) 
  values ('uploads', 'uploads', true)
  on conflict (id) do nothing;
  
  -- Allow any authenticated user to upload (simplification for demo)
  insert into storage.policies (name, definition, bucket_id, read, write, create)
  values 
  ('Authenticated Access', 'bucket_id = ''uploads'' AND auth.role() = ''authenticated''', 'uploads', true, true, true)
  on conflict (name) do nothing;
commit;
