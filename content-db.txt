

-- Projects Table
create table public.content_projects (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  title text,
  aspect_ratio text check (aspect_ratio in ('9:16', '16:9')),
  image_style text,
  picture_quality text default 'Fast',
  voice_id text,
  narration_style text,
  effect text default 'zoom_pulse',
  subtitles text,
  status text default 'draft' check (status in ('draft', 'generating', 'completed', 'failed')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Segments Table
create table public.content_segments (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.content_projects on delete cascade not null,
  narration text,
  image_prompt text,
  image_url text,
  order_index integer not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Stories (Final Videos) Table
create table public.content_stories (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  project_id uuid references public.content_projects on delete set null,
  video_url text,
  thumbnail_url text,
  status text default 'completed',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Creator Transactions (New Table)
create table public.creator_transactions (
  id uuid not null default gen_random_uuid (),
  user_id uuid not null,
  amount numeric not null,
  type text null,
  description text null,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint creator_transactions_pkey primary key (id),
  constraint creator_transactions_user_id_fkey foreign KEY (user_id) references auth.users (id)
) TABLESPACE pg_default;

-- User Configurations
create table public.user_configurations (
  user_id uuid references auth.users on delete cascade primary key,
  prompt text,
  aspect_ratio text,
  image_style text,
  visual_density text,
  voice_id text,
  narration_style text,
  effect text,
  picture_quality text,
  subtitles text,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- RLS Policies

-- Projects
alter table public.content_projects enable row level security;
create policy "Users can view own content projects" on public.content_projects
    for select using (auth.uid() = user_id);
create policy "Users can insert own content projects" on public.content_projects
    for insert with check (auth.uid() = user_id);
create policy "Users can update own content projects" on public.content_projects
    for update using (auth.uid() = user_id);
create policy "Users can delete own content projects" on public.content_projects
    for delete using (auth.uid() = user_id);

-- Segments
alter table public.content_segments enable row level security;
create policy "Users can view own segments" on public.content_segments
    for select using (
      exists (select 1 from public.content_projects where id = content_segments.project_id and user_id = auth.uid())
    );
create policy "Users can insert own segments" on public.content_segments
    for insert with check (
      exists (select 1 from public.content_projects where id = content_segments.project_id and user_id = auth.uid())
    );
create policy "Users can update own segments" on public.content_segments
    for update using (
      exists (select 1 from public.content_projects where id = content_segments.project_id and user_id = auth.uid())
    );
create policy "Users can delete own segments" on public.content_segments
    for delete using (
      exists (select 1 from public.content_projects where id = content_segments.project_id and user_id = auth.uid())
    );

-- Stories
alter table public.content_stories enable row level security;
create policy "Users can view own stories" on public.content_stories
    for select using (auth.uid() = user_id);
create policy "Users can insert own stories" on public.content_stories
    for insert with check (auth.uid() = user_id);
create policy "Users can update own stories" on public.content_stories
    for update using (auth.uid() = user_id);
create policy "Users can delete own stories" on public.content_stories
    for delete using (auth.uid() = user_id);

-- Creator Transactions
alter table public.creator_transactions enable row level security;
create policy "Users can view own creator transactions" on public.creator_transactions
    for select using (auth.uid() = user_id);

-- User Configurations
alter table public.user_configurations enable row level security;
create policy "Users can view own config" on public.user_configurations
    for select using (auth.uid() = user_id);
create policy "Users can insert own config" on public.user_configurations
    for insert with check (auth.uid() = user_id);
create policy "Users can update own config" on public.user_configurations
    for update using (auth.uid() = user_id);

-- Storage bucket for content creator assets
insert into storage.buckets (id, name, public) 
values ('content-assets', 'content-assets', true)
on conflict (id) do nothing;

create policy "Authenticated users can upload to content-assets"
on storage.objects for insert
to authenticated
with check (bucket_id = 'content-assets');

create policy "Authenticated users can read from content-assets"
on storage.objects for select
to authenticated
using (bucket_id = 'content-assets');

-- RPC Functions

-- Function to charge creator credits
-- Deducts from public.profiles and logs to public.creator_transactions
create or replace function charge_creator_credits(
  p_user_id uuid,
  p_amount numeric,
  p_description text
)
returns void
language plpgsql
security definer
as $$
begin
  update public.profiles
  set credits = credits - p_amount,
      updated_at = now()
  where id = p_user_id;

  insert into public.creator_transactions (user_id, amount, type, description)
  values (p_user_id, -p_amount, 'usage', p_description);
end;
$$;

-- Function to refund creator credits
-- Adds to public.profiles and logs to public.creator_transactions
create or replace function refund_creator_credits(
  p_user_id uuid,
  p_amount numeric,
  p_description text
)
returns void
language plpgsql
security definer
as $$
begin
  update public.profiles
  set credits = credits + p_amount,
      updated_at = now()
  where id = p_user_id;

  insert into public.creator_transactions (user_id, amount, type, description)
  values (p_user_id, p_amount, 'refund', p_description);
end;
$$;